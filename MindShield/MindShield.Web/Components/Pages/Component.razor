@page "/"
@using MindShield.Web
@using MindShield.Core
@using Microsoft.EntityFrameworkCore
@inject MindShieldDbContext DbContext
@inject ISafetyService SafetyService
@rendermode InteractiveServer

<div class="glass-panel">
    <h1>MindShield</h1>
    <p class="subtitle">
        Protecting: <strong>@(currentUser?.FullName ?? "Loading...")</strong>
    </p>

    <textarea @bind="postContent" placeholder="What's on your mind?"></textarea>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <span style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">@postContent.Length characters</span>

        <div style="gap: 10px; display: flex;">
            <button class="btn-primary" @onclick="AnalyzePost" disabled="@isScanning">
                @(isScanning ? "Scanning..." : "Check Safety")
            </button>

            @if (canPost)
            {
                <button class="btn-success" @onclick="SimulatePost">🚀 Post to LinkedIn</button>
            }
        </div>
    </div>

    @* --- NEW: PULSING ANALYZING STATE --- *@
    @if (isScanning)
    {
        <div class="analyzing-state">
            <div class="pulse-dot"></div>
            <span>AI is scanning your draft...</span>
        </div>
    }
    @* --- EXISTING: RESULT BOX --- *@
    else if (!string.IsNullOrEmpty(analysisResult))
    {
        <div class="alert-box @alertClass">
            @analysisResult
        </div>
    }
</div>

@if (showGuardianPopup)
{
    <div class="guardian-toast">
        <span style="font-size: 1.5rem;">🔒</span>
        <div>
            <strong>Guardian Notified</strong><br />
            <small>Sent secure alert to Sarah (Wife)</small>
        </div>
    </div>
}

@code {
    private RealityProfile? currentUser;
    private string postContent = "";
    private string analysisResult = "";
    private string alertClass = "";
    private bool showGuardianPopup = false;
    private bool canPost = false; // Controls the Green Button

    // NEW: Controls the animation state
    private bool isScanning = false;

    protected override async Task OnInitializedAsync()
    {
        // Load the user profile (simulated for now)
        // Ensure you have a DbContext properly registered or mock this data
        try
        {
            currentUser = await DbContext.RealityProfiles.FirstOrDefaultAsync();
        }
        catch
        {
            // Fallback if DB isn't ready during dev
            currentUser = new RealityProfile { FullName = "Alex Rivera" };
        }
    }

    private async Task AnalyzePost()
    {
        if (currentUser == null) return;

        // 1. START Loading State
        isScanning = true;            // Turn on animation
        canPost = false;              // Hide post button
        showGuardianPopup = false;    // Hide old popups
        analysisResult = "";          // Clear old text
        StateHasChanged();            // Refresh UI immediately

        // 2. Get the Analysis from Ollama (Simulating network delay helps the demo feel real)
        string rawResult = await SafetyService.AnalyzeAsync(postContent, currentUser);

        // 3. STOP Loading State
        isScanning = false;

        // 4. Process Logic (Your existing Smart Parsing)
        string cleanMessage = rawResult;

        if (rawResult.Contains("[SAFE]"))
        {
            // Cut off the "I cannot assess" junk
            int index = rawResult.IndexOf("[SAFE]");
            // specific logic to handle if [SAFE] is at the start or middle
            // simplistic approach: take everything after the tag
            if (index + 6 < rawResult.Length)
            {
                cleanMessage = rawResult.Substring(index + 6).Trim();
            }
            else
            {
                cleanMessage = "Content looks professional and safe.";
            }

            // ✅ Success
            alertClass = "alert-safe";
            showGuardianPopup = false;
            canPost = true; // Green Button
            analysisResult = cleanMessage;
        }
        else if (rawResult.Contains("[DANGER]"))
        {
            int index = rawResult.IndexOf("[DANGER]");
            if (index + 8 < rawResult.Length)
            {
                cleanMessage = rawResult.Substring(index + 8).Trim();
            }
            else
            {
                cleanMessage = "Risk detected. Please review.";
            }

            // 🚨 Danger
            alertClass = "alert-danger";
            showGuardianPopup = true;
            canPost = false;
            analysisResult = cleanMessage;
        }
        else
        {
            // STRATEGY B: EMERGENCY BACKUP
            string lowerRaw = rawResult.ToLower();

            if (lowerRaw.Contains("safe") || lowerRaw.Contains("good") || lowerRaw.Contains("great"))
            {
                alertClass = "alert-safe";
                canPost = true;
                analysisResult = rawResult;
            }
            else
            {
                alertClass = "alert-warning";
                showGuardianPopup = true;
                canPost = false;
                analysisResult = rawResult;
            }
        }

        StateHasChanged();
    }

    private void SimulatePost()
    {
        // 1. Show Success Message
        analysisResult = "✅ Successfully posted to LinkedIn!";
        alertClass = "alert-safe";

        // 2. Clear the input
        postContent = "";
        canPost = false;
    }
}