@page "/"
@using MindShield.Web
@using MindShield.Core
@using Microsoft.EntityFrameworkCore
@inject MindShieldDbContext DbContext
@inject ISafetyService SafetyService
@rendermode InteractiveServer

<div class="glass-panel">
    <h1>MindShield</h1>
    <p class="subtitle">
        Protecting: <strong>@(currentUser?.FullName ?? "Loading...")</strong>
    </p>

    <textarea @bind="postContent"
              @oninput="OnContentChanged"
              placeholder="What's on your mind?">
</textarea>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <span style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">@postContent.Length characters</span>

        <div style="gap: 10px; display: flex;">
            <button class="btn-primary" @onclick="AnalyzePost" disabled="@isScanning">
                @(isScanning ? "Scanning..." : "Check Safety")
            </button>

            @if (canPost)
            {
                <button class="btn-success" @onclick="SimulatePost">🚀 Post to LinkedIn</button>
            }
        </div>
    </div>

    @* --- NEW: PULSING ANALYZING STATE --- *@
    @if (isScanning)
    {
        <div class="analyzing-state">
            <div class="pulse-dot"></div>
            <span>AI is scanning your draft...</span>
        </div>
    }
    @* --- EXISTING: RESULT BOX --- *@
    else if (safetyResult != null)
    {
        <div class="alert-box @alertClass">
            <strong>@safetyResult.Status</strong><br />
            <p><b>Reason:</b> @safetyResult.Reason</p>

            @if (!string.IsNullOrWhiteSpace(safetyResult.Rewrite))
            {
                <p><b>Suggested Rewrite:</b> @safetyResult.Rewrite</p>
                <button class="btn-primary" @onclick="ApplyRewrite">
                    ✏ Use Suggested Rewrite
                </button>
            }

            <p><b>Recommended Action:</b> @safetyResult.Action</p>
        </div>
    }
</div>

@if (showGuardianPopup)
{
    <div class="guardian-toast">
        <span style="font-size: 1.5rem;">🔒</span>
        <div>
            <strong>Guardian Notified</strong><br />
            <small>Sent secure alert to Sarah (Wife)</small>
        </div>
    </div>
}

@code {
    private RealityProfile? currentUser;
    private string postContent = "";
    private SafetyResult? safetyResult;
    private string alertClass = "";
    private bool showGuardianPopup = false;
    private bool canPost = false;
    private bool isScanning = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUser = await DbContext.RealityProfiles.FirstOrDefaultAsync();
        }
        catch
        {
            currentUser = new RealityProfile { FullName = "Alex Rivera" };
        }
    }

    private async Task AnalyzePost()
    {
        if (currentUser == null) return;

        isScanning = true;
        canPost = false;
        showGuardianPopup = false;
        safetyResult = null;
        StateHasChanged();

        safetyResult = await SafetyService.AnalyzeAsync(postContent, currentUser);

        isScanning = false;

        // LOGIC: Decide based on RiskLevel
        if (safetyResult.Status == "SAFE")
        {
            alertClass = "alert-safe";
            canPost = true;
        }
        else
        {
            canPost = false;

            // 1. Color the box based on severity
            alertClass = (safetyResult.RiskLevel?.Equals("Severe", StringComparison.OrdinalIgnoreCase) == true)
             ? "alert-danger"
             : "alert-warning";

            // 2. TRIGGER GUARDIAN
            // We check if it is DANGER *OR* if RiskLevel is Severe
            if (safetyResult.Status == "DANGER" ||
                safetyResult.RiskLevel?.Equals("Severe", StringComparison.OrdinalIgnoreCase) == true)
            {
                showGuardianPopup = true;
            }
            else
            {
                showGuardianPopup = false;
            }
        }

        StateHasChanged();
    } // <--- This closes AnalyzePost properly

    private void SimulatePost()
    {
        if (safetyResult?.Status != "SAFE")
            return;

        alertClass = "alert-safe";

        safetyResult = new SafetyResult
        {
            Status = "SAFE",
            Reason = "Successfully posted to LinkedIn!",
            Rewrite = "",
            Action = "Post completed."
        };

        postContent = "";
        canPost = false;
    }

    private void ApplyRewrite()
    {
        if (safetyResult != null && !string.IsNullOrWhiteSpace(safetyResult.Rewrite))
        {
            postContent = safetyResult.Rewrite;
            safetyResult = null;
            canPost = false;
            alertClass = "";
        }
    }

    private void OnContentChanged(ChangeEventArgs e)
    {
        safetyResult = null;
        canPost = false;
        alertClass = "";
    }
}